{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block specified_css %}
<link href="{% static 'fullcalendar-4.3.1/packages/core/main.css' %}" rel='stylesheet' />
<link href="{% static 'fullcalendar-4.3.1/packages/daygrid/main.css'%}" rel='stylesheet' />
<link href="{% static 'fullcalendar-4.3.1/packages/timegrid/main.css' %}" rel='stylesheet' />
<link href="{% static 'fullcalendar-4.3.1/packages/list/main.css' %}" rel='stylesheet' />
<script src="{% static 'fullcalendar-4.3.1/packages/core/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages/core/locales-all.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages/interaction/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages/daygrid/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages/timegrid/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages/list/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages-premium/resource-common/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages-premium/resource-daygrid/main.js' %}"></script>
<script src="{% static 'fullcalendar-4.3.1/packages-premium/resource-timegrid/main.js' %} "></script>
<link href="{% static 'css/core/profile/trainees/cards/style.css' %}" rel='stylesheet' />

{% endblock %}

{% block content %}
<section class="page-top-section set-bg" data-setbg="{% static 'img/page-top-bg.jpg'%}">
    <div class="container">
        <div class="row">
            <div class="col-lg-7 m-auto text-white">
                <h2>{% trans 'Extend Card' %}</h2>
            </div>
        </div>
    </div>
</section>
<section class="classes-page-section spad overflow-hidden">
    <div class="container card mt-3 mb-5" id="content">
        <div class="card-body">
            <div class="row justify-content-center">
                <div class="col-md-4 jumbotron">
                    Lorem ipsum dolor sit, amet consectetur adipisicing elit. 
                    Incidunt reiciendis omnis a velit numquam molestias quis illum at voluptas distinctio dolorum molestiae vel, 
                    iusto earum quia ea, quasi, iure mollitia!
                </div>
                <div class="col-md-8">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block specified_js %}
<script>
    $(function () {
        $('html, body').animate({ scrollTop: $('#content').offset().top }, 'slow');
    });
    document.addEventListener('DOMContentLoaded', function () {
        $('[data-toggle="tooltip"]').tooltip();   

        var Draggable = FullCalendarInteraction.Draggable;
        var containerEl = document.getElementById('trial-lesson');

        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            defaultDate: Date.now(),
            editable: true,
            dragRevertDuration: 0,
            dropAccept: '#do-not-drop',
            locale: "{{ request.LANGUAGE_CODE }}",
            events: function (fetchInfo, successCallback, failureCallback) {
                $.ajax({
                    url: "{% url 'classes:get-list-lesson' card.yogaclass.slug %}",
                    type: 'GET',
                    data: {
                        startStr: fetchInfo.startStr,
                        endStr: fetchInfo.endStr
                    },
                    success: function (data) {
                        console.log('data lesson events', data);
                        var events = [];
                        for (var i = 0; i < data.length; i++) {
                            var _d = data[i]['day'];
                            var _st = data[i]['start_time'];
                            var _et = data[i]['end_time'];
                            var _start_time = _d + ' ' + _st;
                            var _end_time = _d + ' ' + _et;
                            var start_time = new Date(_start_time);
                            var end_time = new Date(_end_time);
                            var bg_color = '#0c9463';
                            var border_color = '#0c9463';
                            var editable = true;
                            var title_tooltip = null;
                            if (data[i]['is_full'] == true) {
                                bg_color = '#ef4339';
                                border_color = '#ef4339';
                                editable = false;
                                title_tooltip="{% trans 'lesson is full' %}";
                            }
                            if(jQuery.inArray(parseInt("{{ card.id }}"), data[i]['cards']) !== -1){
                                bg_color = '#596157';
                                border_color = '#596157';
                                editable = false;
                                title_tooltip="{% trans 'has been registered' %}";
                            }
                            events.push({
                                id: data[i]['id'],
                                title: _st.split(':', 2).join(":") + ' - ' + _et.split(':', 2).join(":"),
                                start: start_time,
                                end: end_time,
                                url: 'javascript:;',
                                overlap: false,
                                allDaySlot: false,
                                backgroundColor: bg_color,
                                borderColor: border_color,
                                editable: editable,
                                titleTooltip: title_tooltip
                            });
                        }
                        successCallback(events);
                    }
                });
            },
            eventDragStop: function (info) {
                var start_at = new Date(info.event.start);
                var end_at = new Date(info.event.end);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                var _date_trial = start_at.toLocaleString('{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}', options)
                if (isEventOverDiv(info.jsEvent.offsetX, info.jsEvent.offsetY)) {
                    content = "<div id=trial_" + info.event.id + " class='fc-event fc-event-trial'>";
                    content += '(' + info.event.title + ') ' + _date_trial;
                    content += '<a href="javascript:;" class="float-right a-remove-trial-lesson"><i class="fa fa-fw fa-times"></i></a>';
                    content += "</div>";
                    // content += info.event
                    if ($('#trial-lesson-listing').children().length > 0) {
                        Swal.fire(
                            "{% trans 'error' as t_error %}{{ t_error|title }}",
                            "{% trans 'Trial lesson has been added' %}",
                            'error'
                        )
                    } else {
                        $(content).appendTo('#trial-lesson-listing');
                        const input_date_options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                        var date1 = start_at.toLocaleString('{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}', input_date_options);
                        var date2 = end_at.toLocaleString('{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}', input_date_options);
                        $('#id_start_at').val(date1);
                        $('#id_end_at').val(date2);
                    }
                }
            },
            eventDrop: function (info) {
                if (info != undefined) {
                    info.revert();
                }
                console.log("event drop");
            },
            eventRender: function (info) {
                if (info.event.extendedProps.titleTooltip) {
                    $(info.el).attr('data-toggle',"tooltip"); 
                    $(info.el).attr('title',info.event.extendedProps.titleTooltip); 
                }
            }
        });

        calendar.render();
    });
</script>
{% endblock %}